## VAD MetaModel
### 1 Stencil
Создаем трафарет, [Stencil](https://github.com/bpmbpm/doc/blob/main/BPM/graphic_editor/visio/terms.md) - корпоративный трафарет VAD.  
Состав:
#### Shape
- заголовок процесса. Заголовок процесса - его код (например, p1.2.3), его дочерний элемент - имя (без кода). Полное название = код + имя. Код = имя файла. Переменные: id, name, fullname (составной). Тип = VAD-процесс.
- подпроцесс. Может быть типов, shape=mxgraph.arrows2.arrow 
  - базовый, baseVAD fillColor=#B9E0A5
  - детализированный, detailVAD fillColor=#B9E0A6
  - внешний, externVAD fillColor=#D4E1F5
  - предваряющий, последующий (в дальнейшей реализации)
имеет два дочерних: исполнитель (поле снизу) и комментарий (справа сверху)
- коментарий к схеме процесса. Текстовое поля, которое содержит как коментарии к самомй схеме процесса, так и пояснения к коментариям к фишурам, если они заданы ссылочно (*, 2).
#### Predicate  
- связи в составе фигуры (см. выше, shape)
- имеет следующего (hasNext), может содержать комментарий (в нем можно показывать условие ветвления)

### 2 Pic
При отрисовке соединения (предиката), проверить а) в XML: source="Название_процесса_1" edge="1" target="Название_процесса_2"> и "зеленые коннекторы" (синие, значит - "не связалось") на схеме (иначе в файле будет неверный объект):  
![ris11](https://github.com/bpmbpm/draw-vad/blob/main/notation/pic/VAD-notation.png)

#### id code
Правила замены id на человекочитаемые (shape)
- для VAD: если имя шейпа (не дочернего) начинается не с "p" (value=), то вместо пробелов вставляем "_". Если с "p", то вырезаем левую часть до первого пробела.
  - для baseVAD fillColor=#B9E0A5 замена пробелов на _
  - для detailVAD fillColor=#B9E0A6 и externVAD fillColor=#D4E1F5 вырезаем левую часть (код) до первого пробела
- запомнить заменяемый id и вместо него везде подставить новый
- для Role, fontColor=#1A1A1A - в этой строке к parent="Название_процесса_2" прибавить Role,"Название_процесса_2!Role"
- для Com,  fontColor=#FF6666 - в этой строке к parent="Название_процесса_2" прибавить Com, т.е. id="Название_процесса_2!Com"

Для txt
- код shape=partialRectangle
- название процесса style="text, fontColor=#333333
- Важно: стрелка, сам shape style="endArrow=classic; и стрелка, подпись к стрелке имеет style="edgeLabel;
Однако если оба конца соединены, то примечание уже в одном шейпе с value="". Например:
``` <mxCell id="Название_процесса_1!Название_процесса_2" value="text33" style="endArrow=classic;html=1;rounded=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;exitPerimeter=0;" edge="1" parent="1" source="Название_процесса_1" target="Название_процесса_2">```  
Для добавления \ редактирования надписи на стрелке - нужно выделить стрелку и нажать Enter и тогда редакторовать value (иначе создается рядом отдельный объект text).

### 3 Problems
#### Problem 1. Как в XML задавать тип фигуры? 
- стандартными шейпами
- сделать свой шейп \ имя шейпа. Если через вкладку 
Например: Создали step (библиотека Общие). Его нужно исправить, т.к. работать с ним сложно: стрелка в левую сторону shape перекрывает текст. Поэтому нужно «выпрямить» левую сторону shape=step.  
Делаем собственную фигуру «Исправленный step»: **Положение \ добавить \ фигура.**
``` <shape name="stencilName1" h="24" w="100" aspect="variable" strokewidth="inherit">
  <background>
    <path>
      <move x="0" y="0"/>
      <line x="80" y="0"/>
      <line x="100" y="12"/>
      <line x="80" y="24"/>
      <line x="0" y="24"/>
      <close/>
    </path>
  </background>
  <foreground>
    <fillstroke/>
    
    <stroke/>
  </foreground>
</shape>
```
Хотя можно взять и схожие: Signal-in arrow (Стрелки) или Send Object Action (UML 2.5).  
https://www.drawio.com/doc/faq/shape-complex-create-edit  
https://www.drawio.com/doc/faq/custom-shapes  
#### Problem 1.1
Проблема в том, что а) создается длинное и непонятное имя шейпа б) все равно нужно доопрделять стиль (style) цвет и т.п.  
Текущее решение: используем стандартные шейпы, в стиле определяем ключевой элемент цвет или название шейпа и по нему определяем тип фигуры \ объекта.  
см. в папке vad6.drawio \ lib6.drawio (xml)

#### Problem 2. Заголовочный Nesting в стуктурной схеме
На первом этапе проекта draw-vad предусматриваются два вида схем: структурные и VAD. Для обоих (как и вообще для любых схем) есть [Заголовочный Nesting](https://github.com/bpmbpm/doc/blob/main/BPM/enEA/readme.md#nesting-type)  
Проблема в том, что на структурной схеме (схеме иерархии), если рисовать родительский элемент при парсинге образуется два одноименных родительский элемента: один в заголовке, второй в VAD-кораблике (или прямоугольнике).   
Варинаты решения:  
- не показывать на схеме родительский VAD-кораблик, т.е. его дочерние элементы будут без явной линии (предиката стрелкой :Х :имеетВсоставе :Y). При этом будет показана полько иерархия начиная со второго уровня. 
- вести линию (отношение :имеетВсоставе) от заголовка (от шейпа типа "заголовок процесса"). Прдется предусматривать точки соединения к объекту - заголовку.
- задать иной идентификатор родительского VAD-кораблика в структурной схеме (схеме иерархии)
- задать иной идентификатор схемы \ заголовка в схеме процесса. Например, процессы - p, а схема процесса sp. И далее по аналоии к любому типу объектов добавлять "s". Это также позволит учесть проблему Исключительного Заголовочного Nesting (предваряющие последующие процессы на схеме процесса p будут входить в sp, но не в p).

#### Problem 2.1 Текущее решение
- Кластерного Nesting нет. Предикаты (соединители явные и неявные, например, Role) игнорируются (анализируются только фигуры, obj shape)
- Разбор структурной схемы:
  - в spПроцессА попадают все объекты со схемы, т.е. заголовочный Nesting (хотя в схеме есть и стрелочный в явном виде)
  - в pПроцессА попадают только объекты со связью :имеетВсоставе, т.е. только стрелочный Nesting. 
  - Допускается **только один** уровень вложенности (на первом этапе, далее можно искусственно строить составные структурные схемы).
- Разбор VAD схемы (только заголовочный Nesting):
  -  в spПроцессА попадают все объекты со схемы, включая примечания (note), кроме специальных (заголовок, счетчик страниц и т.п.)
  -  в pПроцессА попадают только объекты типа: baseVAD, detailVAD, externVAD. Общее дерево процессов (без дублей) строится по правилу: detailVAD вставляется как есть, baseVAD - добавляется префикс родительского процесса (для исключения одноименных), externVAD - исключается.  
### Разделители
- ! делит родительское id с дочерним (Role, Com-комментарий) id="Название_процесса_2!Com" или просто два объекта, как в стрелке (style="endArrow=classic).
  -  Как вариант - одноименные id на одной схеме именовать чрез !2, !3 и вести общий счетчик объектов на схеме (чтобы уникальность id внутри схемы обеспечить). Хотя лучше специальный разделитель повторяющихся элементов ввести, например, #.
  - Для note можно установить правило: только одно на схеме. Однако лучше разделить: Примечания и Сокращения. Нормативные документы? 
  - Для стрелок - также - только одна связь (с учетом направления), т.е. id="Название_процесса_1!Название_процесса_2" или id="Название_процесса_2!Название_процесса_1"
- для отделения кода от названия - что? Пробел или специальный символ? 
  
### Help
- Дополнительно \ Редактировать диаграмму (XML)
- Кодировка UTF-8 no BOM
