/**
 * Presentation: HelpController
 * Handles help system and documentation display
 */

class HelpController {
    constructor(app) {
        this.app = app;
        this.helpPages = this.initializeHelpContent();
    }

    initializeHelpContent() {
        return {
            index: {
                title: 'Справка ARIS Express Clone',
                content: `
                    <h1>Добро пожаловать в ARIS Express Clone</h1>
                    <h2>О программе</h2>
                    <p>ARIS Express Clone - это инструмент для моделирования бизнес-процессов, поддерживающий несколько нотаций.</p>

                    <h2>Поддерживаемые нотации</h2>
                    <ul>
                        <li><strong>VAD (Value Added Diagram)</strong> - Диаграмма добавленной стоимости</li>
                        <li><strong>EPC (Event-driven Process Chain)</strong> - Событийная цепочка процессов</li>
                        <li><strong>Организационные диаграммы</strong> - Структура организации</li>
                        <li><strong>BPMN</strong> - Business Process Model and Notation</li>
                    </ul>

                    <h2>Основные функции</h2>
                    <ul>
                        <li>Создание и редактирование диаграмм</li>
                        <li>Сохранение в формате draw.io</li>
                        <li>Экспорт в различные форматы (PNG, SVG, PDF)</li>
                        <li>Валидация моделей согласно правилам нотаций</li>
                    </ul>

                    <h2>Начало работы</h2>
                    <ol>
                        <li>Выберите нотацию в панели трафаретов</li>
                        <li>Перетащите элементы на холст или кликните по ним</li>
                        <li>Настройте свойства элементов в правой панели</li>
                        <li>Сохраните диаграмму через меню Файл → Сохранить</li>
                    </ol>
                `
            },
            vad: {
                title: 'Справка по VAD',
                content: `
                    <h1>VAD - Value Added Chain Diagram (Диаграмма цепочки создания ценности)</h1>
                    <h2>Описание нотации</h2>
                    <p>VAD (Value Added Chain Diagram) - нотация ARIS для представления обзора ключевых функций организации.
                    Диаграмма показывает цепочку создания ценности от стратегических процессов до поддерживающих функций.</p>

                    <h2>Элементы нотации</h2>
                    <h3>1. Функция (Function) - стрелка</h3>
                    <p>Форма: chevron/стрелка</p>
                    <p>Цвет: зеленый (#B9E0A6) для основных процессов</p>
                    <p>Представляет функцию или процесс в цепочке создания ценности.</p>
                    <p>Различные типы стрелок используются для визуального разделения процессов на разных уровнях спецификации.</p>

                    <h3>2. Детализированная функция</h3>
                    <p>Цвет: голубой (#D4E1F5)</p>
                    <p>Процесс, который детализируется в других диаграммах (например, EPC).</p>

                    <h3>3. Процесс (заголовок)</h3>
                    <p>Код и название процесса</p>
                    <p>Используется для идентификации и иерархической организации процессов.</p>

                    <h3>4. Примечание (Note)</h3>
                    <p>Текстовые комментарии и пояснения к диаграмме.</p>

                    <h2>Свойства функций</h2>
                    <ul>
                        <li><strong>Название:</strong> Краткое описание функции</li>
                        <li><strong>Исполнитель:</strong> Отображается под функцией</li>
                        <li><strong>Связи:</strong> Стрелки последовательности между функциями</li>
                    </ul>

                    <h2>Правила моделирования</h2>
                    <ol>
                        <li>Функции располагаются слева направо в порядке выполнения</li>
                        <li>Каждая функция может иметь исполнителя</li>
                        <li>Используйте разные цвета для разделения уровней детализации</li>
                        <li>Диаграмма представляет обзор верхнего уровня процессов</li>
                    </ol>

                    <h2>Примеры использования</h2>
                    <p>VAD используется для:</p>
                    <ul>
                        <li>Визуализации цепочки создания ценности организации</li>
                        <li>Анализа основных и поддерживающих процессов</li>
                        <li>Определения областей для детального моделирования</li>
                        <li>Коммуникации с топ-менеджментом</li>
                    </ul>
                `
            },
            epc: {
                title: 'Справка по EPC',
                content: `
                    <h1>EPC - Event-driven Process Chain (Событийная цепочка процессов)</h1>
                    <h2>Описание нотации</h2>
                    <p>EPC - нотация ARIS для моделирования бизнес-процессов. Основная идея - представление процесса
                    как последовательности событий и функций. EPC характеризуется простотой и понятностью.</p>

                    <h2>Элементы нотации</h2>
                    <h3>1. Событие (Event)</h3>
                    <p>Форма: шестиугольник</p>
                    <p>Цвет: фиолетовый (#E1D5E7)</p>
                    <p>Пассивный элемент, описывающий условия или состояние, при которых выполняется функция,
                    или результирующее состояние после выполнения функции.</p>

                    <h3>2. Функция (Function)</h3>
                    <p>Форма: скругленный прямоугольник</p>
                    <p>Цвет: зеленый (#D5E8D4)</p>
                    <p>Активный элемент, представляющий задачу или деятельность в компании.</p>

                    <h3>3. Логические операторы (Connectors)</h3>
                    <p><strong>AND:</strong> Все пути активируются одновременно</p>
                    <p><strong>XOR:</strong> Активируется только один из альтернативных путей</p>
                    <p><strong>OR (≥1):</strong> Активируется один или несколько путей</p>

                    <h3>4. Организационная единица (Org Unit)</h3>
                    <p>Форма: эллипс</p>
                    <p>Цвет: оранжевый (#FFE6CC)</p>
                    <p>Показывает, какая организационная единица отвечает за выполнение функции.</p>

                    <h3>5. Информация/Данные</h3>
                    <p>Форма: прямоугольник</p>
                    <p>Цвет: голубой (#DAE8FC)</p>
                    <p>Представляет информационные объекты, используемые или создаваемые функцией.</p>

                    <h2>Типы связей</h2>
                    <ul>
                        <li><strong>Поток управления:</strong> Сплошная стрелка между событиями, функциями и операторами</li>
                        <li><strong>Связь с объектами:</strong> Пунктирная линия для связи с организационными единицами и данными</li>
                    </ul>

                    <h2>Правила моделирования</h2>
                    <ol>
                        <li>EPC диаграмма ДОЛЖНА начинаться с события и заканчиваться событием</li>
                        <li>События и функции ДОЛЖНЫ чередоваться</li>
                        <li>Между двумя событиями ДОЛЖНА быть функция</li>
                        <li>Между двумя функциями ДОЛЖНО быть событие</li>
                        <li>Логические операторы используются для ветвления и объединения потоков</li>
                    </ol>

                    <h2>Примеры использования</h2>
                    <p>EPC используется для:</p>
                    <ul>
                        <li>Детального моделирования бизнес-процессов</li>
                        <li>Анализа и оптимизации процессов</li>
                        <li>Документирования рабочих процедур</li>
                        <li>Основы для автоматизации процессов</li>
                    </ul>
                `
            },
            org: {
                title: 'Справка по организационным диаграммам',
                content: `
                    <h1>Организационные диаграммы</h1>
                    <h2>Описание</h2>
                    <p>Организационные диаграммы ARIS используются для представления структуры организации,
                    иерархии подчинения и распределения ответственности.</p>

                    <h2>Элементы нотации</h2>
                    <h3>1. Должность (Position)</h3>
                    <p>Форма: прямоугольник</p>
                    <p>Цвет: оранжевый (#FFE6CC)</p>
                    <p>Представляет должностную позицию в организации.</p>

                    <h3>2. Подразделение (Department/Organizational Unit)</h3>
                    <p>Форма: контейнер</p>
                    <p>Цвет: фиолетовый (#E1D5E7)</p>
                    <p>Представляет организационное подразделение или отдел.</p>

                    <h3>3. Сотрудник (Person)</h3>
                    <p>Форма: человечек (actor)</p>
                    <p>Цвет: зеленый (#D5E8D4)</p>
                    <p>Представляет конкретного сотрудника.</p>

                    <h3>4. Группа (Group)</h3>
                    <p>Форма: эллипс</p>
                    <p>Цвет: голубой (#DAE8FC)</p>
                    <p>Представляет группу сотрудников или команду.</p>

                    <h3>5. Роль (Role)</h3>
                    <p>Форма: скругленный прямоугольник</p>
                    <p>Цвет: розовый (#F8CECC)</p>
                    <p>Представляет функциональную роль.</p>

                    <h2>Типы связей</h2>
                    <ul>
                        <li><strong>Иерархическая связь:</strong> Сплошная стрелка для отношений подчинения</li>
                        <li><strong>Функциональная связь:</strong> Пунктирная линия для функциональных отношений</li>
                    </ul>

                    <h2>Примеры использования</h2>
                    <p>Организационные диаграммы используются для:</p>
                    <ul>
                        <li>Визуализации структуры компании</li>
                        <li>Определения зон ответственности</li>
                        <li>Планирования организационных изменений</li>
                        <li>Связи процессов с исполнителями</li>
                    </ul>
                `
            },
            bpmn: {
                title: 'Справка по BPMN',
                content: `
                    <h1>BPMN - Business Process Model and Notation</h1>
                    <h2>Описание нотации</h2>
                    <p>BPMN - стандартная нотация для моделирования бизнес-процессов, разработанная Object Management Group (OMG).
                    Предназначена для визуализации процессов, понятной как бизнес-пользователям, так и техническим специалистам.</p>

                    <h2>Основные элементы</h2>
                    <h3>1. События (Events)</h3>
                    <p><strong>Начальное событие:</strong> Круг (зеленый контур) - точка начала процесса</p>
                    <p><strong>Конечное событие:</strong> Круг с толстым контуром (красный) - точка завершения процесса</p>
                    <p><strong>Промежуточное событие:</strong> Двойной круг - событие в середине процесса</p>

                    <h3>2. Действия (Activities)</h3>
                    <p><strong>Задача (Task):</strong> Скругленный прямоугольник</p>
                    <p><strong>Подпроцесс (Sub-process):</strong> Скругленный прямоугольник с плюсом</p>

                    <h3>3. Шлюзы (Gateways)</h3>
                    <p><strong>Эксклюзивный (XOR):</strong> Ромб с X - выбор одного пути</p>
                    <p><strong>Параллельный (AND):</strong> Ромб с + - все пути выполняются параллельно</p>
                    <p><strong>Инклюзивный (OR):</strong> Ромб с O - один или несколько путей</p>

                    <h3>4. Пулы и дорожки (Pools and Lanes)</h3>
                    <p><strong>Пул:</strong> Контейнер для процесса, представляющий участника</p>
                    <p><strong>Дорожка:</strong> Подраздел пула, представляющий роль или отдел</p>

                    <h3>5. Потоки</h3>
                    <p><strong>Поток последовательности:</strong> Сплошная стрелка</p>
                    <p><strong>Поток сообщений:</strong> Пунктирная стрелка между пулами</p>
                    <p><strong>Ассоциация:</strong> Пунктирная линия для аннотаций</p>

                    <h2>Правила моделирования</h2>
                    <ol>
                        <li>Процесс начинается с начального события</li>
                        <li>Процесс заканчивается конечным событием</li>
                        <li>Все элементы должны быть связаны потоками</li>
                        <li>Шлюзы используются для управления ходом процесса</li>
                    </ol>

                    <h2>Примеры использования</h2>
                    <p>BPMN используется для:</p>
                    <ul>
                        <li>Стандартизированного моделирования процессов</li>
                        <li>Коммуникации между бизнесом и IT</li>
                        <li>Автоматизации процессов (workflow engines)</li>
                        <li>Анализа и оптимизации процессов</li>
                    </ul>
                `
            }
        };
    }

    showHelp(pageName = 'index') {
        const helpPage = this.helpPages[pageName];

        if (!helpPage) {
            console.warn('Help page not found:', pageName);
            return;
        }

        this.showModal(helpPage.title, helpPage.content);
    }

    showModal(title, content) {
        const modalContainer = document.getElementById('modal-container');
        modalContainer.classList.add('active');

        modalContainer.innerHTML = `
            <div class="modal">
                <div class="modal-header">
                    <div class="modal-title">${title}</div>
                    <button class="modal-close" id="close-help">&times;</button>
                </div>
                <div class="modal-body help-content">
                    ${content}
                </div>
                <div class="modal-footer">
                    <button class="btn" id="help-close-btn">Закрыть</button>
                </div>
            </div>
        `;

        // Attach close handlers
        document.getElementById('close-help').addEventListener('click', () => {
            this.closeModal();
        });

        document.getElementById('help-close-btn').addEventListener('click', () => {
            this.closeModal();
        });

        modalContainer.addEventListener('click', (e) => {
            if (e.target === modalContainer) {
                this.closeModal();
            }
        });
    }

    closeModal() {
        const modalContainer = document.getElementById('modal-container');
        modalContainer.classList.remove('active');
        modalContainer.innerHTML = '';
    }
}
